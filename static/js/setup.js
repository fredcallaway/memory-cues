// Generated by CoffeeScript 2.0.2
// coffeelint: disable=max_line_length, indentation

// ---------- Experiment modes ---------- #
var CONDITION, DEBUG, LOCAL, PROLIFIC, LOG_DEBUG, handleError, psiturk, saveData, startExperiment, submitHit;

searchParams = new URLSearchParams(location.search)

LOCAL = false;
DEBUG = searchParams.get('debug') == 'true';

PROLIFIC = true
// PROLIFIC = (searchParams.get('prolific') == 'true') || 
//   (searchParams.get('hitId') == null) || 
//   (searchParams.get('hitId') == 'prolific');


if (mode === "{{ mode }}") {
  LOCAL = true;
  CONDITION = 0;
}

if (DEBUG) {
  console.log("X X X X X X X X X X X X X X X X X\n X X X X X DEBUG  MODE X X X X X\nX X X X X X X X X X X X X X X X X");
  CONDITION = 0;
  LOG_DEBUG = function(...args) {
    return console.log(...args);
  };
} else {
  console.log("# =============================== #\n# ========= NORMAL MODE ========= #\n# =============================== #");
  CONDITION = parseInt(condition);
  LOG_DEBUG = function(...args) {
    return null;
  };
}

DEBUG_TIMEOUT = false
// ---------- Initialize PsiTurk ---------- #
psiturk = new PsiTurk(uniqueId, adServerLoc, mode);

saveData = function() {
  console.log('saveData');
  return new Promise(function(resolve, reject) {
    var timeout;
    if (LOCAL || mode == 'demo') {
      if (DEBUG_TIMEOUT) { 
        console.log('debug_timeout')
        sleep(3000).then(function() {
          console.log('REJECT')
          reject('timeout')
        });
      } else resolve('local');
      return
    }
    timeout = delay(10000, function() {
      console.log('TIMEOUT');
      return reject('timeout');
    });
    return psiturk.saveData({
      error: function() {
        clearTimeout(timeout);
        console.log('Error saving data!');
        return reject('error');
      },
      success: function() {
        clearTimeout(timeout);
        console.log('Data saved to psiturk server.');
        return resolve();
      }
    });
  });
};

// ---------- Test connection to server, then initialize the experiment. ---------- #
// initializeExperiment is defined in experiment.coffee
$(window).on('load', function() {
  return saveData()
  .then(function() {
    return delay(LOCAL ? 0 : 500, function() {
      $('#welcome').hide();
      if (LOCAL) {
        return initializeExperiment();
      } else {
        return initializeExperiment().catch(handleError);
      }
    });
  })
  .catch(function() {
    return $('#data-error').show();
  });
});

// This function is called once at the end of initializeExperiment.
startExperiment = function(config) {
  var defaults;
  LOG_DEBUG('run');
  defaults = {
    show_progress_bar: false,
    display_element: 'jspsych-target',
    on_finish: function() {
      console.log('on_finish')
      if (DEBUG) {
        return jsPsych.data.displayData();
      } else {
        return submitHit();
      }
    },
    on_data_update: function(data) {
      console.log('data', data);
      return psiturk.recordTrialData(data);
    }
  };
  return jsPsych.init(_.extend(defaults, config));
};

completeHIT = function() {
  $('#jspsych-target').empty()
  console.log('completeHIT')
  if (PROLIFIC) {
    $("#load-icon").remove()
    $(window).off("beforeunload");
    $('body').html(`
      <div class='jspsych-content'>
          <h1>Thanks!</h1>

          <p>
          Your completion code is <b>${PROLIFIC_CODE}</b>
          Click this link to submit<br>
          <a href=https://app.prolific.co/submissions/complete?cc=${PROLIFIC_CODE}>
              https://app.prolific.co/submissions/complete?cc=${PROLIFIC_CODE}
          </a>
          <p>
      </div>
    `)
  } else {
    // psiturk.completeHIT()
  }
}

submitHit = function() {
  var promptResubmit, triesLeft;
  console.log('submitHit');
  $('#jspsych-target').html(`
    <h1>Saving data</h1>

    <p>Please do <b>NOT</b> refresh or leave the page!

    <div id="load-icon"/>

    <div id="submit-error" class="alert alert-danger">
      <strong>Error!</strong>
      We couldn't contact the database. We will try <b><span id="ntry"/></b> more times
      before continuing without saving the data.
    </div>
  `);
  $("#submit-error").hide()
  triesLeft = 3;
  promptResubmit = function() {
    console.log('promptResubmit');
    if (triesLeft) {
      console.log('try again', triesLeft);
      $("#submit-error").show()
      $("#ntry").html(triesLeft)
      triesLeft -= 1;
      return saveData().catch(promptResubmit);
    } else {
      console.log('GIVE UP');
      $('#jspsych-target').html(`
        <h1>Saving data</h1>

        <div class="alert alert-danger">
          <strong>Error!</strong>
          We couldn't save your data! Please send us a message on Prolific.
          Then click the button below.
        </div>
        <br><br>
        <button class='btn btn-primary btn-lg' id="resubmit">I reported the error</button>
      `);
      return new Promise(function(resolve) {
        return $('#resubmit').click(function() {
          $('#jspsych-target').empty()
          return resolve('gave up');
        });
      });
    }
  };
  console.log('hello')
  return saveData(true).catch(promptResubmit).then(completeHIT)
};

handleError = function(e) {
  var link, message, msg;
  console.log('Erorr in experiment', e);
  if (e.stack) {
    msg = e.stack;
  } else if (e.name != null) {
    msg = e.name;
    if (e.message) {
      msg += ': ' + e.message;
    }
  } else {
    msg = e;
  }
  psiturk.recordUnstructuredData('error', msg);
  message = `<pre>\n  HitID: ${(typeof hitId !== "undefined" && hitId !== null ? hitId : 'N/A')}\n  AssignId: ${(typeof assignId !== "undefined" && assignId !== null ? assignId : 'N/A')}\n  WorkerId: ${(typeof workerId !== "undefined" && workerId !== null ? workerId : 'N/A')}\n\n  ${msg}\n</pre>`;
  link = '<a href="mailto:fredcallaway@princeton.edu?subject=ERROR in experiment' + '&body=#{encodeURIComponent(message)}">Click here</a>';
  $('#jspsych-target').html(markdown(`# The experiment encountered an error!\n\n${link} to report the error by email. Please describe at what point in the HIT the error\noccurred, and include the following\n\n${message}\n\nThen click the button below to submit the HIT.\nIf you have trouble submitting the HIT, please\ncontact <fredcallaway@princeton.edu>\n\n<button id="submit">Submit HIT</button>`));
  return $('#submit').click(submitHit);
};
